<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Nonprofit Edge â€” Owner Console</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,700;1,9..40,400&family=Instrument+Serif:ital@0;1&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --navy: #0D2C54;
  --navy-deep: #081b36;
  --navy-light: #143a6b;
  --teal: #0097A9;
  --teal-dim: rgba(0,151,169,0.15);
  --teal-glow: rgba(0,151,169,0.25);
  --gold: #D4A84B;
  --gold-dim: rgba(212,168,75,0.12);
  --bg: #060a10;
  --surface: #0c1219;
  --surface2: #111a24;
  --surface3: #162130;
  --border: #1c2a3a;
  --border-light: #253546;
  --text: #e4e8f0;
  --text-dim: #7a8ba0;
  --text-muted: #4d5d70;
  --success: #34d399;
  --warning: #fbbf24;
  --danger: #f87171;
  --radius: 10px;
  --radius-lg: 14px;
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  font-family:'DM Sans',system-ui,sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
}

/* â•â•â•â•â•â•â•â•â•â•â• LOGIN SCREEN â•â•â•â•â•â•â•â•â•â•â• */
.login-screen {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  background: radial-gradient(ellipse at 30% 20%, rgba(0,151,169,0.06) 0%, transparent 60%),
              radial-gradient(ellipse at 70% 80%, rgba(13,44,84,0.08) 0%, transparent 60%),
              var(--bg);
}

.login-box {
  width: 380px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 40px 36px;
  text-align: center;
}

.login-box .logo-icon {
  width: 56px; height: 56px; border-radius: 14px;
  background: linear-gradient(135deg, var(--navy), var(--teal));
  display: flex; align-items: center; justify-content: center;
  margin: 0 auto 20px; font-weight: 700; font-size: 20px; color: #fff;
  box-shadow: 0 4px 24px rgba(0,151,169,0.2);
}

.login-box h1 {
  font-family:'Instrument Serif',serif;
  font-size: 24px; font-weight: 400; margin-bottom: 4px;
}

.login-box h1 span { color: var(--teal); }
.login-box .sub { font-size: 12px; color: var(--text-dim); margin-bottom: 28px; letter-spacing: 0.04em; text-transform: uppercase; }

.login-box input {
  width: 100%; padding: 12px 16px; background: var(--bg);
  border: 1px solid var(--border); border-radius: 8px;
  color: var(--text); font-family: inherit; font-size: 14px;
  margin-bottom: 14px; text-align: center; letter-spacing: 0.15em;
}

.login-box input:focus { outline: none; border-color: var(--teal); }
.login-box input::placeholder { letter-spacing: normal; color: var(--text-muted); }

.login-box .error { color: var(--danger); font-size: 12px; margin-bottom: 10px; display: none; }

.login-box button {
  width: 100%; padding: 12px; border: none; border-radius: 8px;
  background: linear-gradient(135deg, var(--navy), var(--teal));
  color: #fff; font-family: inherit; font-weight: 600; font-size: 14px;
  cursor: pointer; transition: opacity 0.15s;
}

.login-box button:hover { opacity: 0.9; }

/* â•â•â•â•â•â•â•â•â•â•â• APP LAYOUT â•â•â•â•â•â•â•â•â•â•â• */
.app { display: none; height: 100vh; grid-template-columns: 260px 1fr; grid-template-rows: 56px 1fr; }
.app.visible { display: grid; }

/* â”€â”€â”€ TOPBAR â”€â”€â”€ */
.topbar {
  grid-column: 1/-1; display: flex; align-items: center; justify-content: space-between;
  padding: 0 24px; background: var(--surface); border-bottom: 1px solid var(--border);
}

.topbar-left { display: flex; align-items: center; gap: 12px; }
.topbar-logo { width: 30px; height: 30px; border-radius: 8px;
  background: linear-gradient(135deg, var(--navy), var(--teal));
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; font-weight: 700; color: #fff; }

.topbar h1 { font-family:'Instrument Serif',serif; font-size: 18px; font-weight: 400; }
.topbar h1 span { color: var(--teal); }

.topbar-right { display: flex; align-items: center; gap: 14px; }

.status-badge {
  display: flex; align-items: center; gap: 5px;
  padding: 4px 12px; border-radius: 16px; font-size: 11px; font-weight: 500;
  background: var(--surface2); border: 1px solid var(--border);
}

.status-badge .dot { width: 6px; height: 6px; border-radius: 50%; }
.dot.ok { background: var(--success); }
.dot.off { background: var(--danger); }
.dot.warn { background: var(--warning); }

.topbar .logout-btn {
  padding: 5px 12px; border-radius: 6px; border: 1px solid var(--border);
  background: transparent; color: var(--text-dim); font-family: inherit;
  font-size: 11px; cursor: pointer; transition: all 0.15s;
}

.topbar .logout-btn:hover { border-color: var(--danger); color: var(--danger); }

/* â”€â”€â”€ SIDEBAR â”€â”€â”€ */
.sidebar {
  background: var(--surface); border-right: 1px solid var(--border);
  padding: 16px 12px; overflow-y: auto; display: flex; flex-direction: column; gap: 2px;
}

.sidebar-group { margin-bottom: 18px; }
.sidebar-group-label {
  font-size: 9px; text-transform: uppercase; letter-spacing: 0.12em;
  color: var(--text-muted); padding: 0 10px; margin-bottom: 6px;
}

.nav-item {
  display: flex; align-items: center; gap: 10px;
  padding: 9px 12px; border-radius: 7px; border: none; width: 100%;
  background: transparent; color: var(--text-dim); font-family: inherit;
  font-size: 12.5px; cursor: pointer; transition: all 0.12s; text-align: left;
}

.nav-item:hover { background: var(--surface2); color: var(--text); }
.nav-item.active { background: var(--teal-dim); color: var(--teal); }
.nav-item svg { width: 16px; height: 16px; flex-shrink: 0; opacity: 0.7; }
.nav-item.active svg { opacity: 1; }

.nav-item .badge {
  margin-left: auto; background: var(--surface3); padding: 1px 7px;
  border-radius: 8px; font-size: 10px; color: var(--text-muted);
}

/* â”€â”€â”€ MAIN â”€â”€â”€ */
.main { overflow: hidden; background: var(--bg); }
.panel { display: none; height: 100%; overflow-y: auto; }
.panel.active { display: flex; flex-direction: column; }

.panel-scroll { padding: 28px 32px; flex: 1; overflow-y: auto; }

.panel-title {
  font-family:'Instrument Serif',serif; font-size: 26px; font-weight: 400;
  margin-bottom: 4px;
}

.panel-sub { font-size: 13px; color: var(--text-dim); margin-bottom: 24px; line-height: 1.5; }

/* â•â•â•â•â•â•â•â•â•â•â• SHARED COMPONENTS â•â•â•â•â•â•â•â•â•â•â• */
.card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 20px; margin-bottom: 14px;
}

.card h3 { font-size: 14px; font-weight: 600; margin-bottom: 4px; display: flex; align-items: center; gap: 8px; }
.card p { font-size: 12px; color: var(--text-dim); line-height: 1.5; }

.btn {
  padding: 8px 18px; border-radius: 7px; border: none; font-family: inherit;
  font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.12s;
  display: inline-flex; align-items: center; gap: 6px;
}

.btn-primary { background: linear-gradient(135deg, var(--navy), var(--teal)); color: #fff; }
.btn-primary:hover { opacity: 0.9; }
.btn-teal { background: var(--teal); color: #fff; }
.btn-teal:hover { opacity: 0.85; }
.btn-ghost { background: transparent; color: var(--text-dim); border: 1px solid var(--border); }
.btn-ghost:hover { border-color: var(--teal); color: var(--teal); }
.btn-danger { background: rgba(248,113,113,0.1); color: var(--danger); border: 1px solid rgba(248,113,113,0.2); }
.btn-sm { padding: 5px 12px; font-size: 11px; }

.input, textarea.input {
  width: 100%; padding: 9px 14px; background: var(--bg); border: 1px solid var(--border);
  border-radius: 7px; color: var(--text); font-family: inherit; font-size: 13px;
}

.input:focus, textarea.input:focus { outline: none; border-color: var(--teal); }
.input[type="password"] { font-family:'JetBrains Mono',monospace; font-size: 12px; }

.label { display: block; font-size: 10px; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-dim); margin-bottom: 5px; }

.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 14px; }

.code-block {
  background: var(--bg); border: 1px solid var(--border); border-radius: 8px;
  padding: 16px; font-family:'JetBrains Mono',monospace; font-size: 11.5px;
  line-height: 1.65; color: var(--text-dim); overflow-x: auto; white-space: pre-wrap;
  word-break: break-all; margin: 12px 0; max-height: 400px; overflow-y: auto;
}

.tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 500; }
.tag-teal { background: var(--teal-dim); color: var(--teal); }
.tag-gold { background: var(--gold-dim); color: var(--gold); }
.tag-success { background: rgba(52,211,153,0.12); color: var(--success); }
.tag-danger { background: rgba(248,113,113,0.12); color: var(--danger); }

.divider { border: none; border-top: 1px solid var(--border); margin: 20px 0; }

/* â”€â”€â”€ FILE BROWSER â”€â”€â”€ */
.file-tree { font-family:'JetBrains Mono',monospace; font-size: 12px; }

.file-entry {
  display: flex; align-items: center; gap: 8px; padding: 7px 12px;
  border-radius: 6px; cursor: pointer; transition: background 0.1s;
}

.file-entry:hover { background: var(--surface2); }
.file-entry.dir { color: var(--teal); }
.file-entry.file { color: var(--text-dim); }
.file-entry .icon { font-size: 14px; width: 20px; text-align: center; }

.file-viewer {
  background: var(--bg); border: 1px solid var(--border); border-radius: 8px;
  overflow: hidden; margin-top: 14px;
}

.file-viewer-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 10px 16px; background: var(--surface); border-bottom: 1px solid var(--border);
  font-size: 12px;
}

.file-viewer-content {
  padding: 16px; font-family:'JetBrains Mono',monospace;
  font-size: 11.5px; line-height: 1.6; color: var(--text-dim);
  max-height: 500px; overflow: auto; white-space: pre-wrap; word-break: break-all;
}

/* â”€â”€â”€ CHAT â”€â”€â”€ */
.chat-container { display: flex; flex-direction: column; height: 100%; }
.chat-header { padding: 14px 24px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
.chat-messages { flex: 1; overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 14px; }

.msg { max-width: 78%; padding: 12px 16px; border-radius: 12px; font-size: 13px; line-height: 1.6; }
.msg.user { align-self: flex-end; background: linear-gradient(135deg, var(--navy), var(--navy-light)); color: #fff; border-bottom-right-radius: 4px; }
.msg.assistant { align-self: flex-start; background: var(--surface); border: 1px solid var(--border); border-bottom-left-radius: 4px; }
.msg.system { align-self: center; font-size: 11px; color: var(--text-muted); background: var(--surface2); padding: 6px 14px; border-radius: 16px; }
.msg pre { font-family:'JetBrains Mono',monospace; font-size: 11px; background: var(--bg); padding: 10px; border-radius: 6px; margin: 8px 0; overflow-x: auto; }

.chat-input-bar { padding: 14px 24px; border-top: 1px solid var(--border); display: flex; gap: 10px; }
.chat-input-bar input { flex: 1; }

/* â”€â”€â”€ UPLOAD â”€â”€â”€ */
.dropzone {
  border: 2px dashed var(--border); border-radius: var(--radius); padding: 48px 32px;
  text-align: center; cursor: pointer; transition: all 0.2s; margin-bottom: 20px;
}

.dropzone:hover, .dropzone.dragover { border-color: var(--teal); background: var(--teal-dim); }
.dropzone h3 { font-size: 15px; margin-bottom: 4px; }
.dropzone p { font-size: 12px; color: var(--text-dim); }

.file-item {
  display: flex; align-items: center; gap: 10px; padding: 12px 14px;
  background: var(--surface); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px;
}

.file-item .fi-icon { font-size: 20px; }
.file-item .fi-info { flex: 1; }
.file-item .fi-name { font-size: 12px; font-weight: 500; }
.file-item .fi-meta { font-size: 10px; color: var(--text-muted); }

/* â”€â”€â”€ TABLES â”€â”€â”€ */
.data-table { width: 100%; border-collapse: collapse; font-size: 12px; }
.data-table th { text-align: left; padding: 8px 12px; color: var(--text-muted); font-size: 10px; text-transform: uppercase; letter-spacing: 0.06em; border-bottom: 1px solid var(--border); }
.data-table td { padding: 10px 12px; border-bottom: 1px solid var(--border); color: var(--text-dim); }
.data-table tr:hover td { background: var(--surface); }

/* â”€â”€â”€ RESPONSIVE â”€â”€â”€ */
@media(max-width:768px) {
  .app { grid-template-columns: 1fr; }
  .sidebar { display: none; }
  .grid-2, .grid-3 { grid-template-columns: 1fr; }
}

::-webkit-scrollbar { width: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â• LOGIN â•â•â•â•â•â•â•â•â•â•â• -->
<div class="login-screen" id="loginScreen">
  <div class="login-box">
    <div class="logo-icon">NE</div>
    <h1>Owner <span>Console</span></h1>
    <div class="sub">The Nonprofit Edge â€” Admin Only</div>
    <input type="password" id="loginPass" placeholder="Enter owner password" onkeydown="if(event.key==='Enter')doLogin()">
    <div class="error" id="loginError">Incorrect password</div>
    <button onclick="doLogin()">Unlock Console</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• APP â•â•â•â•â•â•â•â•â•â•â• -->
<div class="app" id="app">

  <!-- TOPBAR -->
  <div class="topbar">
    <div class="topbar-left">
      <div class="topbar-logo">NE</div>
      <h1>Owner <span>Console</span></h1>
    </div>
    <div class="topbar-right">
      <div class="status-badge"><div class="dot" id="dotSupabase"></div><span id="lblSupabase">Supabase</span></div>
      <div class="status-badge"><div class="dot" id="dotGithub"></div><span id="lblGithub">GitHub</span></div>
      <div class="status-badge"><div class="dot" id="dotVercel"></div><span id="lblVercel">Vercel</span></div>
      <div class="status-badge"><div class="dot" id="dotClaude"></div><span id="lblClaude">Claude</span></div>
      <button class="logout-btn" onclick="doLogout()">Lock</button>
    </div>
  </div>

  <!-- SIDEBAR -->
  <nav class="sidebar">
    <div class="sidebar-group">
      <div class="sidebar-group-label">Services</div>
      <button class="nav-item active" data-p="config">âš™ï¸ <span>Configuration</span></button>
      <button class="nav-item" data-p="status">ğŸ“¡ <span>Service Status</span></button>
    </div>
    <div class="sidebar-group">
      <div class="sidebar-group-label">GitHub</div>
      <button class="nav-item" data-p="files">ğŸ“ <span>File Browser</span></button>
      <button class="nav-item" data-p="editor">âœï¸ <span>Edit & Push</span></button>
    </div>
    <div class="sidebar-group">
      <div class="sidebar-group-label">Vercel</div>
      <button class="nav-item" data-p="deploys">ğŸš€ <span>Deployments</span></button>
      <button class="nav-item" data-p="envvars">ğŸ”‘ <span>Env Variables</span></button>
    </div>
    <div class="sidebar-group">
      <div class="sidebar-group-label">Database</div>
      <button class="nav-item" data-p="tables">ğŸ—„ï¸ <span>Supabase Tables</span></button>
      <button class="nav-item" data-p="sql">ğŸ’» <span>SQL Runner</span></button>
    </div>
    <div class="sidebar-group">
      <div class="sidebar-group-label">Knowledge Base</div>
      <button class="nav-item" data-p="upload">ğŸ“¤ <span>Upload Docs</span></button>
      <button class="nav-item" data-p="memories">ğŸ§  <span>Memory Store</span> <span class="badge" id="memBadge">0</span></button>
    </div>
    <div class="sidebar-group">
      <div class="sidebar-group-label">AI</div>
      <button class="nav-item" data-p="chat">ğŸ’¬ <span>Ask Claude</span></button>
    </div>
  </nav>

  <!-- MAIN -->
  <main class="main">

    <!-- CONFIG -->
    <div class="panel active" id="p-config">
      <div class="panel-scroll">
        <div class="panel-title">Service Configuration</div>
        <p class="panel-sub">API keys stored in your browser only. Never sent anywhere except direct API calls to each service.</p>
        <div class="grid-2">
          <div class="card">
            <h3>ğŸ—„ï¸ Supabase</h3>
            <p>Project URL and anon key for database access.</p>
            <div style="margin-top:12px">
              <label class="label">Project URL</label>
              <input class="input" id="cfgSupaUrl" placeholder="https://xxxxx.supabase.co">
              <label class="label" style="margin-top:10px">Anon Key</label>
              <input class="input" type="password" id="cfgSupaKey" placeholder="eyJhbG...">
              <label class="label" style="margin-top:10px">Service Role Key (for SQL/admin)</label>
              <input class="input" type="password" id="cfgSupaServiceKey" placeholder="eyJhbG... (optional)">
            </div>
          </div>
          <div class="card">
            <h3>ğŸ™ GitHub</h3>
            <p>Personal access token with repo permissions.</p>
            <div style="margin-top:12px">
              <label class="label">Token</label>
              <input class="input" type="password" id="cfgGhToken" placeholder="ghp_...">
              <label class="label" style="margin-top:10px">Repo</label>
              <input class="input" id="cfgGhRepo" value="lyncorbett/nonprofit-edge">
              <label class="label" style="margin-top:10px">Branch</label>
              <input class="input" id="cfgGhBranch" value="main">
            </div>
          </div>
          <div class="card">
            <h3>â–² Vercel</h3>
            <p>API token for deploys and environment management.</p>
            <div style="margin-top:12px">
              <label class="label">API Token</label>
              <input class="input" type="password" id="cfgVercelToken" placeholder="Bearer ...">
              <label class="label" style="margin-top:10px">Project ID</label>
              <input class="input" id="cfgVercelProject" placeholder="prj_...">
              <label class="label" style="margin-top:10px">Deploy Hook URL</label>
              <input class="input" id="cfgVercelHook" placeholder="https://api.vercel.com/v1/...">
            </div>
          </div>
          <div class="card">
            <h3>ğŸ”® Claude API</h3>
            <p>Anthropic API key for AI chat with memory context.</p>
            <div style="margin-top:12px">
              <label class="label">API Key</label>
              <input class="input" type="password" id="cfgClaudeKey" placeholder="sk-ant-api03-...">
              <label class="label" style="margin-top:10px">Model</label>
              <input class="input" id="cfgClaudeModel" value="claude-sonnet-4-20250514">
            </div>
          </div>
        </div>
        <div style="margin-top:18px;display:flex;gap:10px">
          <button class="btn btn-primary" onclick="saveConfig()">ğŸ’¾ Save All</button>
          <button class="btn btn-ghost" onclick="loadConfig()">Load Saved</button>
          <button class="btn btn-ghost" onclick="testAll()">ğŸ§ª Test All Connections</button>
        </div>
      </div>
    </div>

    <!-- STATUS -->
    <div class="panel" id="p-status">
      <div class="panel-scroll">
        <div class="panel-title">Service Status</div>
        <p class="panel-sub">Live connectivity check for all services.</p>
        <div id="statusResults"></div>
        <button class="btn btn-teal" onclick="testAll()" style="margin-top:16px">ğŸ”„ Run All Checks</button>
      </div>
    </div>

    <!-- FILE BROWSER -->
    <div class="panel" id="p-files">
      <div class="panel-scroll">
        <div class="panel-title">GitHub File Browser</div>
        <p class="panel-sub">Browse and view all files in <strong id="repoLabel">lyncorbett/nonprofit-edge</strong></p>
        <div style="display:flex;gap:8px;margin-bottom:16px;align-items:center">
          <span style="font-size:12px;color:var(--text-muted)">Path:</span>
          <div id="breadcrumbs" style="display:flex;gap:4px;flex-wrap:wrap"></div>
        </div>
        <div id="fileTree" class="file-tree"></div>
        <div id="fileViewer" class="file-viewer" style="display:none">
          <div class="file-viewer-header">
            <span id="viewerFilename"></span>
            <div style="display:flex;gap:6px">
              <button class="btn btn-sm btn-ghost" onclick="editCurrentFile()">âœï¸ Edit</button>
              <button class="btn btn-sm btn-ghost" onclick="closeViewer()">âœ•</button>
            </div>
          </div>
          <div class="file-viewer-content" id="viewerContent"></div>
        </div>
      </div>
    </div>

    <!-- EDITOR -->
    <div class="panel" id="p-editor">
      <div class="panel-scroll">
        <div class="panel-title">Edit & Push to GitHub</div>
        <p class="panel-sub">Edit files and commit directly to your repo.</p>
        <div style="margin-bottom:14px">
          <label class="label">File Path</label>
          <input class="input" id="editorPath" placeholder="src/components/Dashboard.tsx">
        </div>
        <div style="margin-bottom:14px">
          <label class="label">File Content</label>
          <textarea class="input" id="editorContent" rows="20" style="font-family:'JetBrains Mono',monospace;font-size:11.5px;line-height:1.6;resize:vertical"></textarea>
        </div>
        <div style="margin-bottom:14px">
          <label class="label">Commit Message</label>
          <input class="input" id="editorMsg" placeholder="Update component">
        </div>
        <button class="btn btn-primary" onclick="pushToGithub()">ğŸš€ Commit & Push</button>
        <div id="pushResult" style="margin-top:12px;font-size:12px"></div>
      </div>
    </div>

    <!-- DEPLOYS -->
    <div class="panel" id="p-deploys">
      <div class="panel-scroll">
        <div class="panel-title">Vercel Deployments</div>
        <p class="panel-sub">Recent deploys and trigger new ones.</p>
        <div style="display:flex;gap:10px;margin-bottom:20px">
          <button class="btn btn-teal" onclick="loadDeploys()">ğŸ”„ Refresh</button>
          <button class="btn btn-primary" onclick="triggerDeploy()">ğŸš€ Deploy Now</button>
        </div>
        <div id="deployList"></div>
      </div>
    </div>

    <!-- ENV VARS -->
    <div class="panel" id="p-envvars">
      <div class="panel-scroll">
        <div class="panel-title">Environment Variables</div>
        <p class="panel-sub">Manage Vercel env vars for your project. These are the keys your API routes use.</p>
        <button class="btn btn-ghost" onclick="loadEnvVars()" style="margin-bottom:16px">ğŸ”„ Load Variables</button>
        <div id="envVarList"></div>
      </div>
    </div>

    <!-- TABLES -->
    <div class="panel" id="p-tables">
      <div class="panel-scroll">
        <div class="panel-title">Supabase Tables</div>
        <p class="panel-sub">Browse your database tables and records.</p>
        <div style="display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap">
          <button class="btn btn-ghost btn-sm" onclick="loadTableList()">ğŸ”„ Load Tables</button>
        </div>
        <div id="tableList" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px"></div>
        <div id="tableData"></div>
      </div>
    </div>

    <!-- SQL -->
    <div class="panel" id="p-sql">
      <div class="panel-scroll">
        <div class="panel-title">SQL Runner</div>
        <p class="panel-sub">Execute SQL queries against your Supabase database. Requires service role key.</p>
        <textarea class="input" id="sqlInput" rows="8" style="font-family:'JetBrains Mono',monospace;font-size:12px;line-height:1.5;margin-bottom:12px" placeholder="SELECT * FROM users LIMIT 10;"></textarea>
        <button class="btn btn-primary" onclick="runSQL()">â–¶ Execute</button>
        <div id="sqlResult" style="margin-top:16px"></div>
      </div>
    </div>

    <!-- UPLOAD -->
    <div class="panel" id="p-upload">
      <div class="panel-scroll">
        <div class="panel-title">Upload Documents</div>
        <p class="panel-sub">Upload files to your knowledge base. Content is chunked and stored in Supabase for AI retrieval.</p>
        <div class="dropzone" id="dropzone">
          <h3>ğŸ“‚ Drop files here or click to browse</h3>
          <p>PDF, TXT, DOCX, MD, CSV, JSON â€” up to 10MB</p>
        </div>
        <input type="file" id="fileInput" hidden multiple accept=".pdf,.txt,.docx,.md,.csv,.json,.html,.tsx,.jsx,.ts,.js">
        <div style="margin-bottom:20px">
          <h3 style="font-size:13px;margin-bottom:8px">Or paste text:</h3>
          <textarea class="input" id="pasteText" rows="4" placeholder="Paste any text content..."></textarea>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input class="input" id="pasteTitle" placeholder="Title" style="flex:1">
            <select class="input" id="pasteSource" style="width:140px">
              <option value="manual">Manual</option>
              <option value="meeting-notes">Meeting Notes</option>
              <option value="client-doc">Client Doc</option>
              <option value="strategy">Strategy</option>
              <option value="research">Research</option>
            </select>
            <button class="btn btn-teal" onclick="storePaste()">Store</button>
          </div>
        </div>
        <h3 style="font-size:13px;margin-bottom:10px">Recent Uploads</h3>
        <div id="uploadList"><p style="color:var(--text-muted);font-size:12px">No uploads yet.</p></div>
      </div>
    </div>

    <!-- MEMORIES -->
    <div class="panel" id="p-memories">
      <div class="panel-scroll">
        <div class="panel-title">Memory Store</div>
        <p class="panel-sub">All stored knowledge chunks. Claude uses these as context during chat.</p>
        <div style="display:flex;gap:10px;margin-bottom:16px">
          <input class="input" id="memSearch" placeholder="Search memories..." style="flex:1" onkeydown="if(event.key==='Enter')searchMemories()">
          <button class="btn btn-ghost" onclick="searchMemories()">ğŸ”</button>
          <button class="btn btn-ghost" onclick="loadAllMemories()">ğŸ”„ All</button>
        </div>
        <div id="memoryList"></div>
      </div>
    </div>

    <!-- CHAT -->
    <div class="panel" id="p-chat">
      <div class="chat-container">
        <div class="chat-header">
          <div>
            <strong style="font-size:14px">Ask Claude</strong>
            <span style="font-size:11px;color:var(--text-muted);margin-left:8px" id="chatContext">with full knowledge base</span>
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-sm btn-ghost" onclick="clearChat()">Clear</button>
          </div>
        </div>
        <div class="chat-messages" id="chatMsgs">
          <div class="msg system">Connected to your Supabase knowledge base. Ask anything about The Nonprofit Edge, your clients, or your platform.</div>
        </div>
        <div class="chat-input-bar">
          <input class="input" id="chatInput" placeholder="Ask anything..." onkeydown="if(event.key==='Enter')sendChat()">
          <button class="btn btn-primary" onclick="sendChat()">Send</button>
        </div>
      </div>
    </div>

  </main>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const OWNER_HASH = 'a0f3285b07c26c0dcd2191447f391170d06035e8d57e31a048ba87e46ace5678'; // SHA-256 of password

async function sha256(text) {
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(text));
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
}

async function doLogin() {
  const pass = document.getElementById('loginPass').value;
  const hash = await sha256(pass);
  // First login: if no saved hash, set it
  const savedHash = localStorage.getItem('ne-owner-hash');
  if (!savedHash) {
    localStorage.setItem('ne-owner-hash', hash);
    localStorage.setItem('ne-owner-session', 'active');
    unlock();
    return;
  }
  if (hash === savedHash) {
    localStorage.setItem('ne-owner-session', 'active');
    unlock();
  } else {
    document.getElementById('loginError').style.display = 'block';
    setTimeout(() => document.getElementById('loginError').style.display = 'none', 3000);
  }
}

function doLogout() {
  localStorage.removeItem('ne-owner-session');
  document.getElementById('app').classList.remove('visible');
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('loginPass').value = '';
}

function unlock() {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('app').classList.add('visible');
  loadConfig();
  updateAllDots();
}

// Auto-unlock if session active
if (localStorage.getItem('ne-owner-session') === 'active') {
  unlock();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.querySelectorAll('.nav-item[data-p]').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('p-' + btn.dataset.p).classList.add('active');
  });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let C = {};

function saveConfig() {
  C = {
    supaUrl: el('cfgSupaUrl').value,
    supaKey: el('cfgSupaKey').value,
    supaServiceKey: el('cfgSupaServiceKey').value,
    ghToken: el('cfgGhToken').value,
    ghRepo: el('cfgGhRepo').value,
    ghBranch: el('cfgGhBranch').value,
    vercelToken: el('cfgVercelToken').value,
    vercelProject: el('cfgVercelProject').value,
    vercelHook: el('cfgVercelHook').value,
    claudeKey: el('cfgClaudeKey').value,
    claudeModel: el('cfgClaudeModel').value,
  };
  localStorage.setItem('ne-owner-config', JSON.stringify(C));
  updateAllDots();
  alert('âœ… Saved!');
}

function loadConfig() {
  const s = localStorage.getItem('ne-owner-config');
  if (s) {
    C = JSON.parse(s);
    el('cfgSupaUrl').value = C.supaUrl || '';
    el('cfgSupaKey').value = C.supaKey || '';
    el('cfgSupaServiceKey').value = C.supaServiceKey || '';
    el('cfgGhToken').value = C.ghToken || '';
    el('cfgGhRepo').value = C.ghRepo || 'lyncorbett/nonprofit-edge';
    el('cfgGhBranch').value = C.ghBranch || 'main';
    el('cfgVercelToken').value = C.vercelToken || '';
    el('cfgVercelProject').value = C.vercelProject || '';
    el('cfgVercelHook').value = C.vercelHook || '';
    el('cfgClaudeKey').value = C.claudeKey || '';
    el('cfgClaudeModel').value = C.claudeModel || 'claude-sonnet-4-20250514';
  }
  el('repoLabel').textContent = C.ghRepo || 'lyncorbett/nonprofit-edge';
  updateAllDots();
}

function el(id) { return document.getElementById(id); }

function updateAllDots() {
  setDot('dotSupabase', 'lblSupabase', C.supaUrl && C.supaKey);
  setDot('dotGithub', 'lblGithub', C.ghToken);
  setDot('dotVercel', 'lblVercel', C.vercelToken);
  setDot('dotClaude', 'lblClaude', C.claudeKey);
}

function setDot(dotId, lblId, ok) {
  const d = el(dotId);
  d.className = 'dot ' + (ok ? 'ok' : 'off');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONNECTION TESTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function testAll() {
  const r = el('statusResults');
  r.innerHTML = '<p style="color:var(--text-dim)">Testing...</p>';
  let html = '';

  // Supabase
  try {
    const res = await fetch(`${C.supaUrl}/rest/v1/`, { headers: { apikey: C.supaKey, Authorization: `Bearer ${C.supaKey}` } });
    html += statusCard('Supabase', res.ok, res.ok ? 'Connected' : `HTTP ${res.status}`);
    setDot('dotSupabase', 'lblSupabase', res.ok);
  } catch(e) { html += statusCard('Supabase', false, e.message); }

  // GitHub
  try {
    const res = await fetch(`https://api.github.com/repos/${C.ghRepo}`, { headers: { Authorization: `token ${C.ghToken}` } });
    const d = await res.json();
    html += statusCard('GitHub', res.ok, res.ok ? `${d.full_name} â€” ${d.visibility}` : d.message);
    setDot('dotGithub', 'lblGithub', res.ok);
  } catch(e) { html += statusCard('GitHub', false, e.message); }

  // Vercel
  try {
    const res = await fetch(`https://api.vercel.com/v9/projects/${C.vercelProject}`, { headers: { Authorization: `Bearer ${C.vercelToken}` } });
    const d = await res.json();
    html += statusCard('Vercel', res.ok, res.ok ? `Project: ${d.name}` : 'Failed');
    setDot('dotVercel', 'lblVercel', res.ok);
  } catch(e) { html += statusCard('Vercel', false, e.message); }

  // Claude
  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type':'application/json', 'x-api-key': C.claudeKey, 'anthropic-version':'2023-06-01', 'anthropic-dangerous-direct-browser-access':'true' },
      body: JSON.stringify({ model: C.claudeModel, max_tokens: 10, messages: [{ role:'user', content:'ping' }] })
    });
    html += statusCard('Claude API', res.ok, res.ok ? 'Model: ' + C.claudeModel : `HTTP ${res.status}`);
    setDot('dotClaude', 'lblClaude', res.ok);
  } catch(e) { html += statusCard('Claude', false, e.message); }

  r.innerHTML = html;
}

function statusCard(name, ok, detail) {
  return `<div class="card" style="display:flex;align-items:center;gap:12px">
    <span class="tag ${ok?'tag-success':'tag-danger'}">${ok?'âœ… OK':'âŒ FAIL'}</span>
    <strong style="font-size:13px">${name}</strong>
    <span style="font-size:11px;color:var(--text-dim);margin-left:auto">${detail}</span>
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GITHUB FILE BROWSER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentPath = '';
let currentFileContent = '';
let currentFilePath = '';

async function loadFiles(path='') {
  currentPath = path;
  updateBreadcrumbs();
  const tree = el('fileTree');
  tree.innerHTML = '<p style="color:var(--text-dim);font-size:12px">Loading...</p>';
  el('fileViewer').style.display = 'none';

  try {
    const res = await fetch(`https://api.github.com/repos/${C.ghRepo}/contents/${path}?ref=${C.ghBranch}`, {
      headers: { Authorization: `token ${C.ghToken}` }
    });
    const data = await res.json();
    if (!Array.isArray(data)) { tree.innerHTML = `<p style="color:var(--danger);font-size:12px">Error: ${data.message||'Not found'}</p>`; return; }

    const sorted = data.sort((a,b) => {
      if (a.type !== b.type) return a.type === 'dir' ? -1 : 1;
      return a.name.localeCompare(b.name);
    });

    tree.innerHTML = (path ? `<div class="file-entry dir" onclick="loadFiles('${path.split('/').slice(0,-1).join('/')}')"><span class="icon">â¬†ï¸</span> ..</div>` : '') +
      sorted.map(f => {
        if (f.type === 'dir') return `<div class="file-entry dir" onclick="loadFiles('${f.path}')"><span class="icon">ğŸ“</span> ${f.name}</div>`;
        return `<div class="file-entry file" onclick="viewFile('${f.path}')"><span class="icon">ğŸ“„</span> ${f.name} <span style="margin-left:auto;font-size:10px;color:var(--text-muted)">${(f.size/1024).toFixed(1)}kb</span></div>`;
      }).join('');
  } catch(e) { tree.innerHTML = `<p style="color:var(--danger);font-size:12px">${e.message}</p>`; }
}

function updateBreadcrumbs() {
  const parts = currentPath ? currentPath.split('/') : [];
  el('breadcrumbs').innerHTML =
    `<span style="cursor:pointer;color:var(--teal);font-size:12px" onclick="loadFiles('')">root</span>` +
    parts.map((p, i) => {
      const path = parts.slice(0, i+1).join('/');
      return ` <span style="color:var(--text-muted);font-size:12px">/</span> <span style="cursor:pointer;color:var(--teal);font-size:12px" onclick="loadFiles('${path}')">${p}</span>`;
    }).join('');
}

async function viewFile(path) {
  try {
    const res = await fetch(`https://api.github.com/repos/${C.ghRepo}/contents/${path}?ref=${C.ghBranch}`, {
      headers: { Authorization: `token ${C.ghToken}` }
    });
    const data = await res.json();
    const content = atob(data.content);
    currentFileContent = content;
    currentFilePath = path;

    el('viewerFilename').textContent = path;
    el('viewerContent').textContent = content;
    el('fileViewer').style.display = 'block';
  } catch(e) { alert('Error: ' + e.message); }
}

function closeViewer() { el('fileViewer').style.display = 'none'; }

function editCurrentFile() {
  el('editorPath').value = currentFilePath;
  el('editorContent').value = currentFileContent;
  el('editorMsg').value = `Update ${currentFilePath.split('/').pop()}`;
  // Switch to editor panel
  document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelector('[data-p="editor"]').classList.add('active');
  el('p-editor').classList.add('active');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GITHUB PUSH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function pushToGithub() {
  const path = el('editorPath').value;
  const content = el('editorContent').value;
  const msg = el('editorMsg').value || 'Update from Owner Console';
  if (!path || !content) return alert('Need path and content');

  el('pushResult').innerHTML = '<span style="color:var(--warning)">Pushing...</span>';

  try {
    // Get existing SHA
    let sha;
    try {
      const ex = await fetch(`https://api.github.com/repos/${C.ghRepo}/contents/${path}?ref=${C.ghBranch}`, {
        headers: { Authorization: `token ${C.ghToken}` }
      });
      if (ex.ok) sha = (await ex.json()).sha;
    } catch {}

    const res = await fetch(`https://api.github.com/repos/${C.ghRepo}/contents/${path}`, {
      method: 'PUT',
      headers: { Authorization: `token ${C.ghToken}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: msg, content: btoa(unescape(encodeURIComponent(content))), branch: C.ghBranch, ...(sha && { sha }) })
    });

    if (res.ok) {
      const d = await res.json();
      el('pushResult').innerHTML = `<span style="color:var(--success)">âœ… ${sha ? 'Updated' : 'Created'} â€” commit ${d.commit.sha.substring(0,7)}</span>`;
    } else {
      const e = await res.json();
      el('pushResult').innerHTML = `<span style="color:var(--danger)">âŒ ${e.message}</span>`;
    }
  } catch(e) { el('pushResult').innerHTML = `<span style="color:var(--danger)">âŒ ${e.message}</span>`; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VERCEL DEPLOYS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadDeploys() {
  const d = el('deployList');
  d.innerHTML = '<p style="color:var(--text-dim);font-size:12px">Loading...</p>';
  try {
    const res = await fetch(`https://api.vercel.com/v6/deployments?projectId=${C.vercelProject}&limit=10`, {
      headers: { Authorization: `Bearer ${C.vercelToken}` }
    });
    const data = await res.json();
    if (!data.deployments?.length) { d.innerHTML = '<p style="color:var(--text-dim);font-size:12px">No deployments found.</p>'; return; }

    d.innerHTML = data.deployments.map(dep => {
      const state = dep.readyState || dep.state;
      const stateTag = state === 'READY' ? 'tag-success' : state === 'ERROR' ? 'tag-danger' : 'tag-gold';
      return `<div class="card" style="display:flex;align-items:center;gap:12px">
        <span class="tag ${stateTag}">${state}</span>
        <div>
          <div style="font-size:12px">${dep.url || 'no url'}</div>
          <div style="font-size:10px;color:var(--text-muted)">${new Date(dep.created).toLocaleString()} â€” ${dep.meta?.githubCommitMessage || 'manual deploy'}</div>
        </div>
      </div>`;
    }).join('');
  } catch(e) { d.innerHTML = `<p style="color:var(--danger);font-size:12px">${e.message}</p>`; }
}

async function triggerDeploy() {
  if (!C.vercelHook) return alert('Set your deploy hook URL in Configuration first');
  try {
    const res = await fetch(C.vercelHook, { method: 'POST' });
    if (res.ok) { alert('âœ… Deploy triggered!'); setTimeout(loadDeploys, 3000); }
    else alert('âŒ Failed: ' + res.status);
  } catch(e) { alert('âŒ ' + e.message); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VERCEL ENV VARS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadEnvVars() {
  const d = el('envVarList');
  d.innerHTML = '<p style="color:var(--text-dim);font-size:12px">Loading...</p>';
  try {
    const res = await fetch(`https://api.vercel.com/v9/projects/${C.vercelProject}/env`, {
      headers: { Authorization: `Bearer ${C.vercelToken}` }
    });
    const data = await res.json();
    if (!data.envs?.length) { d.innerHTML = '<p>No variables found.</p>'; return; }

    d.innerHTML = `<table class="data-table"><thead><tr><th>Key</th><th>Target</th><th>Updated</th></tr></thead><tbody>` +
      data.envs.map(e => `<tr><td style="font-family:'JetBrains Mono',monospace;font-size:11px">${e.key}</td><td>${(e.target||[]).join(', ')}</td><td>${new Date(e.updatedAt).toLocaleDateString()}</td></tr>`).join('') +
      '</tbody></table>';
  } catch(e) { d.innerHTML = `<p style="color:var(--danger);font-size:12px">${e.message}</p>`; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUPABASE TABLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadTableList() {
  const key = C.supaServiceKey || C.supaKey;
  try {
    // Use REST API to check known tables
    const tables = ['users','organizations','memories','monthly_usage','activity_log','tool_sessions','professor_conversations','professor_messages','templates','marketing_emails','daily_quotes','events','resources','assessments'];
    const tl = el('tableList');
    tl.innerHTML = '';

    for (const t of tables) {
      try {
        const res = await fetch(`${C.supaUrl}/rest/v1/${t}?select=*&limit=1`, {
          headers: { apikey: key, Authorization: `Bearer ${key}`, Prefer: 'count=exact' }
        });
        if (res.ok) {
          const count = res.headers.get('content-range')?.split('/')[1] || '?';
          const btn = document.createElement('button');
          btn.className = 'btn btn-sm btn-ghost';
          btn.textContent = `${t} (${count})`;
          btn.onclick = () => loadTable(t);
          tl.appendChild(btn);
        }
      } catch {}
    }
    if (!tl.children.length) tl.innerHTML = '<p style="color:var(--text-muted);font-size:12px">No tables found. Run the SQL setup first.</p>';
  } catch(e) { el('tableList').innerHTML = `<p style="color:var(--danger)">${e.message}</p>`; }
}

async function loadTable(name) {
  const key = C.supaServiceKey || C.supaKey;
  const d = el('tableData');
  d.innerHTML = `<p style="color:var(--text-dim)">Loading ${name}...</p>`;

  try {
    const res = await fetch(`${C.supaUrl}/rest/v1/${name}?select=*&limit=50&order=created_at.desc`, {
      headers: { apikey: key, Authorization: `Bearer ${key}` }
    });
    const data = await res.json();
    if (!data.length) { d.innerHTML = `<p style="color:var(--text-dim)">Table "${name}" is empty.</p>`; return; }

    const cols = Object.keys(data[0]).slice(0, 8);
    d.innerHTML = `<h3 style="font-size:14px;margin-bottom:10px">${name}</h3>
      <div style="overflow-x:auto"><table class="data-table"><thead><tr>${cols.map(c => `<th>${c}</th>`).join('')}</tr></thead><tbody>` +
      data.map(row => `<tr>${cols.map(c => {
        let v = row[c];
        if (v === null) return '<td style="color:var(--text-muted)">null</td>';
        if (typeof v === 'object') v = JSON.stringify(v).substring(0, 60);
        if (typeof v === 'string' && v.length > 60) v = v.substring(0, 60) + '...';
        return `<td>${v}</td>`;
      }).join('')}</tr>`).join('') +
      '</tbody></table></div>';
  } catch(e) { d.innerHTML = `<p style="color:var(--danger)">${e.message}</p>`; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SQL RUNNER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function runSQL() {
  const sql = el('sqlInput').value;
  if (!sql) return;
  const key = C.supaServiceKey || C.supaKey;
  const d = el('sqlResult');
  d.innerHTML = '<p style="color:var(--warning)">Running...</p>';

  try {
    const res = await fetch(`${C.supaUrl}/rest/v1/rpc/`, {
      method: 'POST',
      headers: { apikey: key, Authorization: `Bearer ${key}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({})
    });
    // RPC won't work for raw SQL via REST â€” use pg-meta endpoint
    const pgRes = await fetch(`${C.supaUrl}/pg/query`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${C.supaServiceKey}`,
        'apikey': C.supaServiceKey
      },
      body: JSON.stringify({ query: sql })
    });

    if (pgRes.ok) {
      const data = await pgRes.json();
      d.innerHTML = `<div class="code-block">${JSON.stringify(data, null, 2)}</div>`;
    } else {
      // Fallback: tell user to use Supabase dashboard
      d.innerHTML = `<div class="card"><p>Direct SQL requires the pg-meta endpoint which may not be exposed. Use the <strong>Supabase SQL Editor</strong> in your dashboard for complex queries.</p>
        <p style="margin-top:8px">For simple queries, try using the <strong>Tables</strong> panel or use REST API filters.</p>
        <a href="${C.supaUrl?.replace('.supabase.co','')}.supabase.com/project/default/sql" target="_blank" class="btn btn-teal btn-sm" style="margin-top:10px">Open Supabase SQL Editor â†’</a></div>`;
    }
  } catch(e) { d.innerHTML = `<div class="card"><p>SQL execution requires the Supabase Management API. For now, use the SQL Editor in your Supabase dashboard:</p>
    <a href="https://supabase.com/dashboard" target="_blank" class="btn btn-teal btn-sm" style="margin-top:10px">Open Supabase Dashboard â†’</a></div>`; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UPLOAD & MEMORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const dropzone = el('dropzone');
const fileInput = el('fileInput');

dropzone.onclick = () => fileInput.click();
dropzone.ondragover = e => { e.preventDefault(); dropzone.classList.add('dragover'); };
dropzone.ondragleave = () => dropzone.classList.remove('dragover');
dropzone.ondrop = e => { e.preventDefault(); dropzone.classList.remove('dragover'); handleFiles(e.dataTransfer.files); };
fileInput.onchange = e => handleFiles(e.target.files);

async function handleFiles(files) {
  for (const file of files) {
    const item = addUploadItem(file.name, file.size, 'processing');
    try {
      const text = await file.text();
      await storeChunks(file.name, text, 'upload');
      item.querySelector('.fi-tag').className = 'tag tag-success fi-tag';
      item.querySelector('.fi-tag').textContent = 'Stored';
    } catch(e) {
      item.querySelector('.fi-tag').className = 'tag tag-danger fi-tag';
      item.querySelector('.fi-tag').textContent = 'Error';
    }
  }
}

function addUploadItem(name, size, status) {
  const list = el('uploadList');
  if (list.querySelector('p')) list.innerHTML = '';
  const ext = name.split('.').pop().toUpperCase();
  const div = document.createElement('div');
  div.className = 'file-item';
  div.innerHTML = `<span class="fi-icon">${{PDF:'ğŸ“„',TXT:'ğŸ“',MD:'ğŸ“‹',CSV:'ğŸ“Š',DOCX:'ğŸ“ƒ',JSON:'ğŸ”§',TSX:'âš›ï¸',JSX:'âš›ï¸',HTML:'ğŸŒ'}[ext]||'ğŸ“'}</span>
    <div class="fi-info"><div class="fi-name">${name}</div><div class="fi-meta">${(size/1024).toFixed(1)} KB</div></div>
    <span class="tag tag-gold fi-tag">Processing...</span>`;
  list.prepend(div);
  return div;
}

async function storeChunks(title, content, source) {
  const chunks = [];
  const sentences = content.split(/(?<=[.!?\n])\s+/);
  let cur = '';
  for (const s of sentences) {
    if (cur.length + s.length > 1000 && cur) { chunks.push(cur.trim()); cur = ''; }
    cur += s + ' ';
  }
  if (cur.trim()) chunks.push(cur.trim());

  const key = C.supaKey;
  for (let i = 0; i < chunks.length; i++) {
    await fetch(`${C.supaUrl}/rest/v1/memories`, {
      method: 'POST',
      headers: { apikey: key, Authorization: `Bearer ${key}`, 'Content-Type': 'application/json', Prefer: 'return=minimal' },
      body: JSON.stringify({
        title: chunks.length > 1 ? `${title} (${i+1}/${chunks.length})` : title,
        content: chunks[i], source,
        metadata: { original: title, chunk: i, total: chunks.length }
      })
    });
  }
  refreshMemCount();
}

async function storePaste() {
  const text = el('pasteText').value;
  const title = el('pasteTitle').value || 'Manual entry';
  const source = el('pasteSource').value;
  if (!text) return alert('Enter text first');
  await storeChunks(title, text, source);
  el('pasteText').value = ''; el('pasteTitle').value = '';
  alert('âœ… Stored!');
}

async function refreshMemCount() {
  try {
    const res = await fetch(`${C.supaUrl}/rest/v1/memories?select=id&limit=1`, {
      headers: { apikey: C.supaKey, Authorization: `Bearer ${C.supaKey}`, Prefer: 'count=exact' }
    });
    const c = res.headers.get('content-range')?.split('/')[1] || '0';
    el('memBadge').textContent = c;
  } catch {}
}

async function loadAllMemories() {
  const d = el('memoryList');
  d.innerHTML = '<p style="color:var(--text-dim);font-size:12px">Loading...</p>';
  try {
    const res = await fetch(`${C.supaUrl}/rest/v1/memories?select=*&order=created_at.desc&limit=100`, {
      headers: { apikey: C.supaKey, Authorization: `Bearer ${C.supaKey}` }
    });
    const data = await res.json();
    renderMemories(data);
  } catch(e) { d.innerHTML = `<p style="color:var(--danger)">${e.message}</p>`; }
}

async function searchMemories() {
  const q = el('memSearch').value;
  if (!q) return loadAllMemories();
  const d = el('memoryList');
  d.innerHTML = '<p style="color:var(--text-dim);font-size:12px">Searching...</p>';
  try {
    const res = await fetch(`${C.supaUrl}/rest/v1/memories?or=(title.ilike.*${encodeURIComponent(q)}*,content.ilike.*${encodeURIComponent(q)}*)&order=created_at.desc&limit=50`, {
      headers: { apikey: C.supaKey, Authorization: `Bearer ${C.supaKey}` }
    });
    renderMemories(await res.json());
  } catch(e) { d.innerHTML = `<p style="color:var(--danger)">${e.message}</p>`; }
}

function renderMemories(data) {
  const d = el('memoryList');
  if (!data.length) { d.innerHTML = '<p style="color:var(--text-muted);font-size:12px">No memories found.</p>'; return; }
  d.innerHTML = data.map(m => `<div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <span class="tag tag-teal">${m.source||'?'}</span>
      <span style="font-size:10px;color:var(--text-muted)">${new Date(m.created_at).toLocaleString()}</span>
    </div>
    <strong style="font-size:12px">${m.title||'Untitled'}</strong>
    <p style="margin-top:4px">${(m.content||'').substring(0,250)}${m.content?.length>250?'...':''}</p>
    <button class="btn btn-sm btn-danger" style="margin-top:8px" onclick="deleteMemory('${m.id}')">Delete</button>
  </div>`).join('');
}

async function deleteMemory(id) {
  if (!confirm('Delete this memory?')) return;
  await fetch(`${C.supaUrl}/rest/v1/memories?id=eq.${id}`, {
    method: 'DELETE', headers: { apikey: C.supaKey, Authorization: `Bearer ${C.supaKey}` }
  });
  loadAllMemories();
  refreshMemCount();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHAT WITH CLAUDE + MEMORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let chatHistory = [];

async function sendChat() {
  const input = el('chatInput');
  const msg = input.value.trim();
  if (!msg) return;
  input.value = '';
  addMsg('user', msg);

  if (!C.claudeKey) { addMsg('system', 'âš ï¸ Add Claude API key in Configuration'); return; }

  // Retrieve memories
  let context = '';
  if (C.supaUrl && C.supaKey) {
    try {
      const res = await fetch(`${C.supaUrl}/rest/v1/memories?select=title,content,source&order=created_at.desc&limit=25`, {
        headers: { apikey: C.supaKey, Authorization: `Bearer ${C.supaKey}` }
      });
      const mems = await res.json();
      context = mems.map(m => `[${m.source}] ${m.title}: ${m.content}`).join('\n\n');
      el('chatContext').textContent = `${mems.length} memories loaded`;
    } catch {}
  }

  chatHistory.push({ role: 'user', content: msg });
  addMsg('assistant', '...');

  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type':'application/json', 'x-api-key': C.claudeKey, 'anthropic-version':'2023-06-01', 'anthropic-dangerous-direct-browser-access':'true' },
      body: JSON.stringify({
        model: C.claudeModel, max_tokens: 4096,
        system: `You are the AI assistant for The Nonprofit Edge, a platform founded by Lyn Corbett, PhD. You provide McKinsey-level nonprofit consulting advice.

You have access to this knowledge base:

<knowledge_base>
${context || 'No memories stored yet.'}
</knowledge_base>

Use this context to give informed, specific answers. Reference relevant stored information naturally. You're talking directly to Lyn, the platform owner.`,
        messages: chatHistory
      })
    });
    const data = await res.json();
    const reply = data.content?.[0]?.text || 'No response';
    const msgs = el('chatMsgs');
    msgs.removeChild(msgs.lastElementChild);
    addMsg('assistant', reply);
    chatHistory.push({ role: 'assistant', content: reply });
  } catch(e) {
    const msgs = el('chatMsgs');
    msgs.removeChild(msgs.lastElementChild);
    addMsg('system', 'âŒ ' + e.message);
  }
}

function addMsg(role, text) {
  const msgs = el('chatMsgs');
  const div = document.createElement('div');
  div.className = 'msg ' + role;
  div.textContent = text;
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
}

function clearChat() { el('chatMsgs').innerHTML = '<div class="msg system">Chat cleared. Memories still loaded.</div>'; chatHistory = []; }

// Init
if (C.ghToken) setTimeout(() => loadFiles(''), 500);
if (C.supaKey) setTimeout(refreshMemCount, 600);
</script>

</body>
</html>
